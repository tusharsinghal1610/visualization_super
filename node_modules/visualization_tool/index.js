
var readJson = require('read-package-json')
var Graph = require("./graph")
const readline = require('readline').createInterface({
    input: process.stdin,
    output: process.stdout
});
var shouldRun = true;
var mygraph = new Graph();

var buildGraph = async function () {
    return new Promise((resolve, reject) => {
        readJson('./package.json', console.error, false, async function (er, data) {
            if (er) {
                console.error("There was an error reading the file")
                reject();
            }
            else {
                var dependencies = Object.keys(data.dependencies);
                await mygraph.buildGraph(dependencies);
                resolve();
            }
        });
    });
}

var takeChoice = async function () {
    return new Promise((resolve, reject) => {
        readline.question(`1. Get the dependents\n2. Get the dependency tree \n3. Get full dependency tree of current project \n4. Exit\n`, (choice) => {
            if (choice == '1') {
                readline.question('\nEnter the package for which you want to know the dependents\n', (dependency) => {
                    console.log("\n\n");
                    mygraph.getDependents(dependency)      
                    readline.pause();
                    resolve();
                });
            }
            else if (choice == '2') {
                readline.question('\n Enter the dependency\n', (dependency) => {
                    console.log("\n\n");
                    readline.pause();
                    mygraph.showGraph([dependency]);
                    resolve();
                });
            }
            else if (choice == '3') {
                console.log("\n\n");
                //show full dependency tree
                mygraph.showGraph();
                resolve();
            }
            else {
                console.log("\n\n");
                readline.pause();
                shouldRun = false;
                resolve();
            }
        });
    })
}

var repeater = async function () {
    while (shouldRun) {
        console.log("\n\n");
        await takeChoice();
        console.log("\n\n")
    }
}

var mainFunction = async function(){
    await buildGraph();
    repeater();
}

mainFunction();


